<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SHAP Explanations</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div class="container">
  <h1>SHAP Explanations for Cinnamon Quality</h1>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="local">Local SHAP</div>
    <div class="tab" data-tab="global">Global SHAP</div>
  </div>

  <!-- Local SHAP -->
  <div id="local" class="tab-content active">
      <h2>Local SHAP (Single Input)</h2>
      <div id="feature-inputs"></div>
      <button id="predict-btn" class="btn">Predict & Explain</button>
      <div id="result">
          <strong>Predicted Label:</strong> <span id="predicted-label">-</span>
      </div>
      <div class="visual-section">
          <h4>Bar Plot (This Case)</h4>
          <img id="shap_local_bar" src="" />
      </div>
  </div>

  <!-- Global SHAP -->
<div id="global" class="tab-content container">
    <h2>Global SHAP</h2>
    <button id="global-btn" class="btn">Load Global SHAP</button>

    <div class="visual-section">
        <h4>Feature Importance (Bar Plot)</h4>
        <img id="shap-global-bar" src="" />
    </div>

    <div class="visual-section">
        <h4>Dependence Plot (Select Feature)</h4>
        <select id="feature-select">
        </select>
        <button id="dependence-btn" class="btn">Show Dependence Plot</button>
        <img id="shap-global-dependence" src="" />
    </div>
</div>
</div>

<script>
const FEATURES = ["Moisture","Ash","Volatile_Oil","Acid_Insoluble_Ash","Chromium","Coumarin","Fiber","Density","Oil_Content","Resin","Pesticide_Level","PH_Value"];

const DEFAULT_VALUES = {
    "Moisture": 7.573517876694799,
    "Ash": 1.327439423202109,
    "Volatile_Oil": 2.0912413100313714,
    "Acid_Insoluble_Ash": 0.1618542921215591,
    "Chromium": 0.43037713048648674,
    "Coumarin": 0.36282449006450246,
    "Fiber": 10.792416727036484,
    "Density": 0.9128768352865284,
    "Oil_Content": 6.022598957291718,
    "Resin": 2.3581499071562795,
    "Pesticide_Level": 0.013171581881226115,
    "PH_Value": 5.901047299
};

// Tabs functionality
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// Generate inputs
const inputsDiv = document.getElementById('feature-inputs');
FEATURES.forEach(f=>{
    const inp = document.createElement('input');
    inp.type='number';
    inp.id=f;
    inp.placeholder=f;
    inp.value = DEFAULT_VALUES[f];  // <--- set default
    inputsDiv.appendChild(inp);
});

// Populate dropdown
const featureSelect = document.getElementById("feature-select");
FEATURES.forEach((f, idx)=>{
    const opt = document.createElement("option");
    opt.value = idx; opt.text = f;
    featureSelect.appendChild(opt);
});

// Local SHAP
document.getElementById('predict-btn').addEventListener('click', ()=>{
    const payload = {};
    FEATURES.forEach(f=>{ payload[f] = parseFloat(document.getElementById(f).value || 0); });
    fetch('/predict_shap',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
    }).then(r=>r.json()).then(data=>{
        if(data.error){ alert(data.error); return; }
        document.getElementById('predicted-label').innerText = data.predicted_label;
        document.getElementById('shap_local_bar').src = 'data:image/png;base64,'+data.shap_local_bar;

    });
});

// Load Global SHAP
document.getElementById('global-btn').addEventListener('click', ()=>{
    fetch('/global_shap').then(r=>r.json()).then(data=>{
        if(data.error){ alert(data.error); return; }
        document.getElementById('shap-global-bar').src='data:image/png;base64,'+data.shap_global_bar;
        // initial dependence plot = first feature
        document.getElementById('shap-global-dependence').src='data:image/png;base64,'+data.shap_global_dependence;
    });
});

// Dependence plot for selected feature
document.getElementById('dependence-btn').addEventListener('click', ()=>{
    const featureIndex = document.getElementById('feature-select').value;
    fetch(`/dependence_plot?feature_index=${featureIndex}`).then(r=>r.json()).then(data=>{
        if(data.error){ alert(data.error); return; }
        document.getElementById('shap-global-dependence').src='data:image/png;base64,'+data.shap_global_dependence;
    });
});
</script>

</body>
</html>
