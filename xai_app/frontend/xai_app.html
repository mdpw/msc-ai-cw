<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SHAP Explanations</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div id="loading-notification" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#fffae6; color:#333; padding:10px 20px; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:999;">
    Please wait...
</div>
<div class="container">
  <h1>SHAP Explanations for Cinnamon Quality</h1>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="local">Local SHAP</div>
    <div class="tab" data-tab="global">Global SHAP</div>
  </div>

  <!-- Local SHAP -->
<div id="local" class="tab-content active">
    <h2>Local SHAP (Single Input)</h2>
    <div id="feature-inputs" class="feature-inputs"></div>
    <button id="predict-btn" class="btn">Predict & Explain</button>
    <div id="result">
        <strong>Predicted Label:</strong> <span id="predicted-label">-</span>
    </div>

    <div class="visual-section">
        <h4>Bar Plot (Top Contributors)</h4>
        <img id="shap_local_bar" src="" />
    </div>

    <div class="visual-section">
        <h4>Waterfall Plot (This Case)</h4>
        <img id="shap_local_waterfall" src="" />
    </div>
</div>

  <!-- Global SHAP -->
<div id="global" class="tab-content container">
    <h2>Global SHAP</h2>
    <button id="global-btn" class="btn">Load Global SHAP</button>

    <div class="visual-section">
        <h4>Feature Importance (Bar Plot)</h4>
        <img id="shap-global-bar" src="" />
    </div>

    <div class="visual-section">
        <h4>Dependence Plot (Select Feature)</h4>
        <select id="feature-select">
        </select>
        <button id="dependence-btn" class="btn">Show Dependence Plot</button>
        <img id="shap-global-dependence" src="" />
    </div>
</div>
</div>

<script>
function showLoading() {
    document.getElementById('loading-notification').style.display = 'block';
}
function hideLoading() {
    document.getElementById('loading-notification').style.display = 'none';
}
const FEATURES = ["Moisture","Ash","Volatile_Oil","Acid_Insoluble_Ash","Chromium","Coumarin","Fiber","Density","Oil_Content","Resin","Pesticide_Level","PH_Value"];

const DEFAULT_VALUES = {
    "Moisture": 5.912319684631715,
    "Ash": 1.5245575304055563,
    "Volatile_Oil": 1.068158558466343,
    "Acid_Insoluble_Ash": 0.1633210264116448,
    "Chromium": 0.4276723149361204,
    "Coumarin": 0.2147153432347099,
    "Fiber": 13.461451497437334,
    "Density": 0.9482843588359212,
    "Oil_Content": 7.207146265003943,
    "Resin": 0.9821564582970372,
    "Pesticide_Level": 0.042154103,
    "PH_Value": 4.676990080336132
};

// Tabs functionality
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// Generate inputs with labels
const inputsDiv = document.getElementById('feature-inputs');
FEATURES.forEach(f=>{
    const wrapper = document.createElement('div');
    wrapper.classList.add('input-wrapper'); // optional, for styling

    const label = document.createElement('label');
    label.htmlFor = f;
    label.innerText = f;

    const inp = document.createElement('input');
    inp.type='number';
    inp.id=f;
    inp.value = DEFAULT_VALUES[f];  // default value
    inp.placeholder=f;

    wrapper.appendChild(label);
    wrapper.appendChild(inp);
    inputsDiv.appendChild(wrapper);
});

// Populate dropdown
const featureSelect = document.getElementById("feature-select");
FEATURES.forEach((f, idx)=>{
    const opt = document.createElement("option");
    opt.value = idx; opt.text = f;
    featureSelect.appendChild(opt);
});

// Local SHAP
document.getElementById('predict-btn').addEventListener('click', ()=>{
    const payload = {};
    FEATURES.forEach(f=>{ payload[f] = parseFloat(document.getElementById(f).value || 0); });

    showLoading();  // show notification

    fetch('/predict_shap',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
    }).then(r=>r.json()).then(data=>{
        hideLoading(); // hide notification
        if(data.error){ alert(data.error); return; }
        document.getElementById('predicted-label').innerText = data.predicted_label;
        document.getElementById('shap_local_bar').src = 'data:image/png;base64,'+data.shap_local_bar;
        document.getElementById('shap_local_waterfall').src = 'data:image/png;base64,'+data.shap_local_waterfall;
    }).catch(e=>{
        hideLoading();
        alert('Error: ' + e);
    });
});

// Load Global SHAP
document.getElementById('global-btn').addEventListener('click', ()=>{
    showLoading();
    fetch('/global_shap').then(r=>r.json()).then(data=>{
        hideLoading();
        if(data.error){ alert(data.error); return; }
        document.getElementById('shap-global-bar').src='data:image/png;base64,'+data.shap_global_bar;
        document.getElementById('shap-global-dependence').src='data:image/png;base64,'+data.shap_global_dependence;
    }).catch(e=>{
        hideLoading();
        alert('Error: ' + e);
    });
});

// Dependence plot for selected feature
document.getElementById('dependence-btn').addEventListener('click', ()=>{
    const featureIndex = document.getElementById('feature-select').value;
    showLoading();
    fetch(`/dependence_plot?feature_index=${featureIndex}`).then(r=>r.json()).then(data=>{
        hideLoading();
        if(data.error){ alert(data.error); return; }
        document.getElementById('shap-global-dependence').src='data:image/png;base64,'+data.shap_global_dependence;
    }).catch(e=>{
        hideLoading();
        alert('Error: ' + e);
    });
});
</script>

</body>
</html>
